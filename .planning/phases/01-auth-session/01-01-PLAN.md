---
phase: 01-auth-session
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/community/src/lib/auth.ts
  - packages/community/src/app/middleware.ts
  - packages/community/src/types/next-auth.d.ts
  - packages/community/src/app/auth/[...nextauth]/route.ts
  - packages/community/package.json
autonomous: true
user_setup:
  - service: Microsoft Entra ID (Azure AD)
    why: "SSO identity provider for GDAI application"
    env_vars:
      - name: AUTH_MICROSOFT_ENTRA_ID_ID
        source: "Azure Portal -> App registrations -> GDAI Client App -> Application (client) ID"
      - name: AUTH_MICROSOFT_ENTRA_ID_SECRET
        source: "Azure Portal -> App registrations -> GDAI Client App -> Certificates & secrets -> New client secret"
      - name: AUTH_MICROSOFT_ENTRA_ID_ISSUER
        source: "https://login.microsoftonline.com/<TENANT_ID>/v2.0 — get Tenant ID from Azure Portal -> Microsoft Entra ID -> Overview"
      - name: AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
    dashboard_config:
      - task: "Register GDAI Client application in Azure AD"
        location: "Azure Portal -> Microsoft Entra ID -> App registrations -> New registration"
      - task: "Register GDAI Snowflake Resource application in Azure AD (for Snowflake audience scope)"
        location: "Azure Portal -> Microsoft Entra ID -> App registrations -> New registration"
      - task: "Define scope on Snowflake Resource app (e.g., session:role-any)"
        location: "Azure Portal -> App registrations -> GDAI Snowflake Resource -> Expose an API -> Add a scope"
      - task: "Grant GDAI Client app delegated permission to Snowflake Resource app scope"
        location: "Azure Portal -> App registrations -> GDAI Client App -> API permissions -> Add a permission -> My APIs"
      - task: "Add redirect URI for NextAuth callback"
        location: "Azure Portal -> App registrations -> GDAI Client App -> Authentication -> Add platform -> Web -> http://localhost:3000/api/auth/callback/microsoft-entra-id"

must_haves:
  truths:
    - "Navigating to any application URL redirects to Microsoft SSO login when unauthenticated"
    - "No application UI or page content renders before authentication completes"
    - "After successful SSO login, user arrives at the application with a valid session"
    - "Session contains user identity (name, email) from Microsoft Entra ID"
  artifacts:
    - path: "packages/community/src/lib/auth.ts"
      provides: "NextAuth configuration with MicrosoftEntraID provider and JWT strategy"
      contains: "MicrosoftEntraID"
    - path: "packages/community/src/app/middleware.ts"
      provides: "Auth guard redirecting unauthenticated requests to sign-in"
      contains: "middleware"
    - path: "packages/community/src/types/next-auth.d.ts"
      provides: "TypeScript module augmentation for JWT and Session types"
      contains: "access_token"
  key_links:
    - from: "packages/community/src/app/middleware.ts"
      to: "packages/community/src/lib/auth.ts"
      via: "import { auth } from '@/lib/auth'"
      pattern: "auth.*from.*@/lib/auth"
    - from: "packages/community/src/app/auth/[...nextauth]/route.ts"
      to: "packages/community/src/lib/auth.ts"
      via: "import { GET, POST } from '@/lib/auth'"
      pattern: "GET.*POST.*from.*@/lib/auth"
---

<objective>
Replace the existing GitHub OAuth provider with Microsoft Entra ID SSO and implement an auth guard that prevents any application UI from rendering until the user is authenticated.

Purpose: AUTH-01 requires that all access to the application goes through Microsoft SSO with zero UI leakage before authentication. This is the foundation for all subsequent Snowflake session scoping and permission tier resolution.

Output: Working Microsoft SSO login flow — unauthenticated users are redirected to Microsoft login; authenticated users reach the application with a JWT session containing their access_token.
</objective>

<execution_context>
@/Users/Rob.Ford/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Rob.Ford/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-session/01-RESEARCH.md

Key existing files to reference:
@packages/community/src/lib/auth.ts — Current GitHub provider config (will be replaced)
@packages/community/src/lib/adapter.ts — Current Vercel KV adapter (will be removed)
@packages/community/src/app/middleware.ts — Currently empty (will be implemented)
@packages/community/src/app/auth/[...nextauth]/route.ts — Route handler (minimal changes)
@packages/community/package.json — Dependencies to update
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace GitHub provider with MicrosoftEntraID and switch to JWT session strategy</name>
  <files>
    packages/community/src/lib/auth.ts
    packages/community/src/types/next-auth.d.ts
    packages/community/src/app/auth/[...nextauth]/route.ts
    packages/community/package.json
  </files>
  <action>
1. Remove `@vercel/kv`, `octokit`, and `passport-local` from `packages/community/package.json` dependencies. Add `snowflake-sdk` (needed by Plan 01-02 but install now to avoid a second install step). Run `yarn install` from the repo root.

2. Create `packages/community/src/types/next-auth.d.ts` with module augmentation:
   - Augment `next-auth/jwt` `JWT` interface: add `access_token: string`, `expires_at: number`, `refresh_token?: string`, `permissionTier?: "standard" | "elevated"`, `error?: "RefreshTokenError"`, `snowflake_token?: string` (separate Snowflake-audience token — see Research Open Question 3).
   - Augment `next-auth` `Session` interface: add `access_token: string`, `permissionTier: "standard" | "elevated"`, `error?: "RefreshTokenError"`.
   - Use `declare module` syntax. Import nothing from the adapter.

3. Rewrite `packages/community/src/lib/auth.ts`:
   - Remove GitHub import and Adapter import.
   - Import `NextAuth` from `next-auth` and `MicrosoftEntraID` from `next-auth/providers/microsoft-entra-id`.
   - Configure the provider:
     ```
     MicrosoftEntraID({
       clientId: process.env.AUTH_MICROSOFT_ENTRA_ID_ID!,
       clientSecret: process.env.AUTH_MICROSOFT_ENTRA_ID_SECRET!,
       issuer: process.env.AUTH_MICROSOFT_ENTRA_ID_ISSUER!,
       authorization: {
         params: {
           scope: "openid profile email offline_access",
         },
       },
     })
     ```
   - Set `session: { strategy: "jwt" }` (replaces the current `database` strategy).
   - Remove the `adapter: Adapter()` line entirely.
   - Add `jwt` callback: On initial sign-in (`if (account)`), store `account.access_token`, `account.expires_at`, `account.refresh_token` in the token. For now, set `token.permissionTier = "standard"` as a placeholder (Plan 01-02 will add the Snowflake role check). Return the token if not expired (`Date.now() < token.expires_at * 1000`). If expired, return the token as-is for now (Plan 01-03 will add refresh logic).
   - Add `session` callback: Copy `token.access_token`, `token.permissionTier ?? "standard"`, and `token.error` into the session.
   - Export `{ handlers, auth, signIn, signOut }` from the `NextAuth()` call.
   - Export `const { GET, POST } = handlers` for the route handler.

4. Update `packages/community/src/app/auth/[...nextauth]/route.ts` to import `{ GET, POST }` from `@/lib/auth` (should already match — verify).

IMPORTANT: Do NOT use the deprecated `next-auth/providers/azure-ad`. Use `next-auth/providers/microsoft-entra-id`.
IMPORTANT: Do NOT use a database adapter. JWT strategy means no adapter is needed.
IMPORTANT: The `authorization.params.scope` will need to include the Snowflake resource scope (e.g., `api://<snowflake-app-id>/session:role-any`) once Azure AD app registration is configured. For now, use the basic OIDC scopes. Add a `// TODO(01-02): Add Snowflake resource scope once Azure AD app registration is configured` comment.
  </action>
  <verify>
    - `yarn tsc --noEmit -p packages/community/tsconfig.json` compiles without errors
    - `packages/community/src/lib/auth.ts` does NOT import from `./adapter`
    - `packages/community/src/lib/auth.ts` imports `MicrosoftEntraID` (not `GitHub`, not `AzureAD`)
    - `packages/community/src/lib/auth.ts` sets `session: { strategy: "jwt" }` (not `database`)
    - `packages/community/package.json` does NOT list `@vercel/kv` or `octokit` in dependencies
    - `packages/community/src/types/next-auth.d.ts` exists and augments JWT with `access_token`
  </verify>
  <done>
    NextAuth is configured with MicrosoftEntraID provider and JWT session strategy. Type augmentations define access_token, permissionTier, and error fields on JWT and Session. Vercel KV adapter and GitHub-specific dependencies are removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auth guard middleware that blocks all unauthenticated access</name>
  <files>
    packages/community/src/app/middleware.ts
  </files>
  <action>
Rewrite `packages/community/src/app/middleware.ts` (currently a no-op that imports NextRequest but does nothing):

1. Import `{ auth }` from `@/lib/auth`.
2. Export `default auth` as the middleware function, wrapping it with a callback:
   ```typescript
   export { auth as middleware } from "@/lib/auth"
   ```

   Wait — next-auth v5's middleware pattern is:
   ```typescript
   import { auth } from "@/lib/auth"

   export default auth((req) => {
     if (!req.auth) {
       const signInUrl = new URL("/api/auth/signin", req.nextUrl.origin)
       return Response.redirect(signInUrl)
     }
   })
   ```

   Use this pattern. The middleware runs on every matched route. If `req.auth` is falsy (no session), redirect to the sign-in page.

3. Export a `config` object with a `matcher` array that excludes Next.js internals, static assets, and the auth API route itself:
   ```typescript
   export const config = {
     matcher: ["/((?!api/auth|_next/static|_next/image|favicon.ico).*)"],
   }
   ```

   The `api/auth` exclusion prevents infinite redirect loops (the sign-in page itself must be accessible without auth).

IMPORTANT: The middleware file path in Next.js App Router must be at `src/app/middleware.ts` OR `src/middleware.ts` (root of src). Check the current file location. If it's at `src/app/middleware.ts`, it may need to move to `src/middleware.ts` for Next.js to pick it up. Next.js only recognizes middleware at the project root or `src/` root, NOT inside `app/`. Verify the correct location by checking the Next.js config and move the file if necessary.

IMPORTANT: Do NOT redirect `/api/auth/*` routes — these must remain accessible for the OAuth callback flow.
  </action>
  <verify>
    - Middleware file exists at the correct Next.js-recognized location (either `packages/community/src/middleware.ts` or `packages/community/middleware.ts`)
    - Middleware imports `auth` from `@/lib/auth`
    - Middleware redirects to sign-in when `req.auth` is falsy
    - Matcher excludes `api/auth`, `_next/static`, `_next/image`, `favicon.ico`
    - `yarn tsc --noEmit -p packages/community/tsconfig.json` compiles without errors
  </verify>
  <done>
    Auth guard middleware is in place. Every route except the auth API endpoints and static assets requires authentication. Unauthenticated users are redirected to Microsoft SSO sign-in. No application UI renders before authentication.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `yarn tsc --noEmit -p packages/community/tsconfig.json` passes
2. No references to GitHub provider, Vercel KV, or database session strategy remain in auth code
3. Middleware file is at the correct Next.js-recognized path
4. Module augmentation file exists with correct JWT/Session type extensions
5. The auth route handler at `src/app/auth/[...nextauth]/route.ts` still correctly re-exports GET and POST
</verification>

<success_criteria>
- NextAuth configured with MicrosoftEntraID provider (not GitHub)
- JWT session strategy (not database)
- Auth guard middleware blocks all unauthenticated access
- Type augmentations define access_token, permissionTier, and error on JWT and Session
- Vercel KV adapter removed
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-session/01-01-SUMMARY.md`
</output>
