---
phase: 01-auth-session
task: deferred
status: microsoft_sso_deferred_dev_auth_active
last_updated: 2026-02-19
---

<current_state>
Phase 1 auth is in a working state for development. Microsoft Entra ID SSO (Plan 01-03 checkpoint) is deferred — infrastructure not yet configured. Snowflake key-pair dev auth is implemented and committed (36857674).

The phase can be formally closed and Phase 2 started. The Azure AD SSO work will be revisited before production.
</current_state>

<completed_work>

- Plan 01-01 ✓ — azure-ad provider, JWT session, auth guard middleware, type augmentations
- Plan 01-02 ✓ — Snowflake OAuth connection factory, IS_ROLE_IN_SESSION permission tier
- Plan 01-03, Task 1 ✓ — refreshAccessToken with rotation
- Plan 01-03, Task 2 ✓ — useSessionWatchdog, SessionProvider, URL preservation
- Plan 01-03, Task 3 — DEFERRED (Azure AD infrastructure not yet configured)
- Dev auth (added) ✓ — Snowflake key-pair auth via SNOWFLAKE_DEV_AUTH=true + SNOWFLAKE_PRIVATE_KEY_PATH

</completed_work>

<dev_auth_setup>

To use Snowflake key-pair dev auth, set in `packages/community/.env.local`:

```
SNOWFLAKE_DEV_AUTH=true
SNOWFLAKE_ACCOUNT=<account-identifier>
SNOWFLAKE_PRIVATE_KEY_PATH=<path-to-rsa-private-key.p8>
SNOWFLAKE_PRIVATE_KEY_PASSPHRASE=<passphrase-if-encrypted>
SNOWFLAKE_ELEVATED_ROLE=GDAI_ELEVATED
AUTH_SECRET=<openssl rand -base64 32>
```

The login page will show a "Snowflake (Dev)" credentials form. Enter your Snowflake username to authenticate.

**Generate RSA key pair for Snowflake:**
```bash
openssl genrsa 2048 | openssl pkcs8 -topk8 -v2 des3 -inform PEM -out rsa_key.p8
openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub
```
Then assign the public key to your Snowflake user:
```sql
ALTER USER <username> SET RSA_PUBLIC_KEY='<contents of rsa_key.pub minus header/footer>';
```

</dev_auth_setup>

<deferred_work>

Microsoft Entra ID SSO is deferred. Resume when Azure AD infrastructure is configured:

1. Two Azure AD app registrations (GDAI Client + Snowflake Resource)
2. Snowflake External OAuth Security Integration (CREATE SECURITY INTEGRATION — see Plan 01-02 user_setup)
3. Set env vars: AUTH_MICROSOFT_ENTRA_ID_ID, AUTH_MICROSOFT_ENTRA_ID_SECRET, AUTH_MICROSOFT_ENTRA_ID_ISSUER, SNOWFLAKE_OAUTH_SCOPE
4. Re-run the human-verify checkpoint from Plan 01-03 Task 3

Open question: whether Azure AD requires OBO flow or single-scope for Snowflake token (error 390318/390144 will clarify). See auth.ts comment and 01-RESEARCH.md.

</deferred_work>

<next_action>
Phase 1 is functionally complete for development purposes. Options:

1. Mark Phase 1 complete (treating Azure AD as deferred) → proceed to Phase 2 (SSA Core)
   - Run: gsd-verifier on Phase 1 to check what can be verified without live Azure AD
   - Update ROADMAP.md + REQUIREMENTS.md + STATE.md

2. Set up Snowflake key-pair credentials and verify dev auth works first

3. Return to Azure AD SSO later as a separate insert-phase

Recommended: Option 1 — proceed to Phase 2 with dev auth working.
</next_action>
