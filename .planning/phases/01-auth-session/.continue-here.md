---
phase: 01-auth-session
task: debug-dev-server
status: blocked
last_updated: 2026-02-19
---

<current_state>
All Phase 1 code is committed. Trying to start the community package dev server and hitting ERR_CONNECTION_RESET in the browser. The server may not be binding or is crashing on startup. Haven't diagnosed the root cause yet.
</current_state>

<completed_work>

- Plan 01-01 ✓ — azure-ad provider, JWT session, auth guard middleware (commits: 2cbfb963, 1a70adab, ffeeaee1)
- Plan 01-02 ✓ — Snowflake OAuth connection factory, IS_ROLE_IN_SESSION permission tier (commits: 7976c937, a6961e14, 91c894bf)
- Plan 01-03, Task 1 ✓ — refreshAccessToken with rotation (commit: d75710e2)
- Plan 01-03, Task 2 ✓ — useSessionWatchdog, SessionProvider, URL preservation (commit: 3f4afe3d)
- Plan 01-03, Task 3 — DEFERRED (Azure AD infrastructure not configured)
- Dev auth ✓ — Snowflake key-pair auth via SNOWFLAKE_DEV_AUTH=true (commit: 36857674)
- .env.local ✓ — populated from ~/.snowflake/connections.toml (not committed, gitignored)
- snowflake.ts ✓ — warehouse/database/schema added to key-pair connection (commit: 0d461064)

</completed_work>

<remaining_work>

- Debug ERR_CONNECTION_RESET on dev server startup
- Verify dev auth flow (login page → Snowflake key-pair → session with permissionTier)
- Once verified: formally close Phase 1, run verifier, update ROADMAP.md
- Then: proceed to Phase 2 (SSA Core)

</remaining_work>

<decisions_made>

- azure-ad provider (not microsoft-entra-id) — correct for next-auth@5.0.0-beta.3
- JWT augmentation in @auth/core/jwt — next-auth/jwt is empty in beta.3
- Permission tier from Snowflake role (SYSADMIN = elevated for dev)
- Dev auth gated on SNOWFLAKE_DEV_AUTH=true env var
- Azure AD SSO deferred until infrastructure is configured

</decisions_made>

<blockers>

- **ERR_CONNECTION_RESET**: `cd packages/community && node ../../.yarn/releases/yarn-4.6.0.cjs dev` — browser gets connection reset. Possible causes:
  1. Server not actually starting (crash during boot — look for startup errors in terminal output)
  2. Port 3000 already in use
  3. Next.js config issue in the community package
  4. Missing required env vars causing crash before server binds

  To diagnose: run the dev server and watch the full terminal output. Look for errors before "Ready" message.

- **9 pre-existing TypeScript errors** in community package — unrelated to auth, deferred

</blockers>

<context>
The community package is a Next.js 15 app in packages/community/. It was originally the Rivet community template sharing site, repurposed as the GDAI web shell.

Start the server with:
```bash
cd packages/community && node ../../.yarn/releases/yarn-4.6.0.cjs dev
```

The .env.local at packages/community/.env.local has:
- SNOWFLAKE_DEV_AUTH=true
- SNOWFLAKE_ACCOUNT=AI92964-TOB73292
- SNOWFLAKE_PRIVATE_KEY_PATH=/Users/Rob.Ford/.ssh/rsa_key.p8
- SNOWFLAKE_ELEVATED_ROLE=SYSADMIN
- SNOWFLAKE_WAREHOUSE=COMPUTE_WH
- AUTH_SECRET=<set>
- NEXTAUTH_URL=http://localhost:3000

If server starts but auth fails:
- Check browser console for errors
- Check terminal output for next-auth errors
- The login route is /api/auth/signin
- Provider id is "snowflake-keypair"
</context>

<next_action>
1. Run the dev server and capture the FULL terminal output (not just browser error)
2. Look for crash/error before "Ready on http://localhost:3000"
3. Likely fix: missing env var, import error, or port conflict
</next_action>
